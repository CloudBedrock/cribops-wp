services:
  wordpress:
    image: cloudbedrock/cribops-wp:latest
    depends_on:
      - db
      - redis
    ports:
      - "8080:80"
      - "8443:443"  # HTTPS port
    environment:
      SERVER_NAME: ${SERVER_NAME:-localhost}
      # PHP Configuration for large uploads
      PHP_INI_UPLOAD_MAX_FILESIZE: ${MAX_UPLOAD_SIZE:-512M}
      PHP_INI_POST_MAX_SIZE: ${MAX_UPLOAD_SIZE:-512M}
      PHP_INI_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT:-512M}
      PHP_INI_MAX_EXECUTION_TIME: ${PHP_MAX_EXECUTION_TIME:-600}
      PHP_INI_MAX_INPUT_TIME: ${PHP_MAX_EXECUTION_TIME:-600}
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
      # Set WordPress site URL and home URL
      WORDPRESS_SITEURL: ${WORDPRESS_SITEURL:-http://localhost:8080}
      WORDPRESS_HOME: ${WORDPRESS_HOME:-http://localhost:8080}
      # WordPress admin credentials
      WP_ADMIN_USER: ${WP_ADMIN_USER:-admin}
      WP_ADMIN_PASSWORD: ${WP_ADMIN_PASSWORD:-password123}
      WP_ADMIN_EMAIL: ${WP_ADMIN_EMAIL:-admin@example.com}
      WP_SITE_TITLE: ${WP_SITE_TITLE:-My WordPress Site}
      WP_ACTIVE_THEME: ${WP_ACTIVE_THEME:-etch-theme}
      # Debug settings (base image uses WORDPRESS_DEBUG)
      WORDPRESS_DEBUG: ${WP_DEBUG:-false}
      WORDPRESS_CONFIG_EXTRA: |
        /* Core Configuration */
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);

        /* Memory Limits */
        define('WP_MEMORY_LIMIT', '${PHP_MEMORY_LIMIT:-512M}');
        define('WP_MAX_MEMORY_LIMIT', '${PHP_MEMORY_LIMIT:-512M}');

        /* Debug Configuration */
        define('WP_DEBUG_LOG', ${WP_DEBUG_LOG:-true});
        define('WP_DEBUG_DISPLAY', ${WP_DEBUG_DISPLAY:-false});
        @ini_set('display_errors', ${WP_DEBUG_DISPLAY:-false} ? 1 : 0);

        /* URLs are managed dynamically - do not hardcode */
        /* define('WP_SITEURL', '${WORDPRESS_SITEURL}'); */
        /* define('WP_HOME', '${WORDPRESS_HOME}'); */

        /* MailPit SMTP Configuration */
        define('MAILPIT_SMTP_HOST', 'mailpit');
        define('MAILPIT_SMTP_PORT', 1025);
        define('MAILPIT_WEB_UI', 'http://localhost:8025');

        /* Custom Configuration from .env */
        ${WP_CONFIG_EXTRA:-}
    volumes:
      - wordpress_data:/var/www/html
      # Mount local plugins/themes to temp locations for one-way copy
      - ./plugins:/local-plugins:ro
      - ./themes:/local-themes:ro
      - ./mu-plugins:/local-mu-plugins:ro
      - ./media:/local-media:ro
      # Mount initialization script
      - ./docker-entrypoint-initwp.d:/docker-entrypoint-initwp.d:ro
      # Mount custom entrypoint wrapper
      - ./docker-entrypoint-wrapper.sh:/usr/local/bin/docker-entrypoint-wrapper.sh:ro
      # Mount PHP configuration for uploads
      - ./php-uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro
      # Mount PHP info page
      - ./phpinfo.php:/var/www/html/phpinfo.php:ro
      # Mount SSL certificates (optional - create with ./scripts/setup-ssl.sh)
      - ./ssl:/etc/ssl/wordpress:ro
      # Mount Apache SSL config (optional)
      - ./apache-ssl.conf:/etc/apache2/sites-available/default-ssl.conf:ro
    entrypoint: ["/usr/local/bin/docker-entrypoint-wrapper.sh"]
    command: ["apache2-foreground"]

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
      MYSQL_RANDOM_ROOT_PASSWORD: '1'
    volumes:
      - db_data:/var/lib/mysql

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP server
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    profiles:
      - mailpit

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    restart: unless-stopped
    command:
      - "http"
      - "wordpress:80"
    ports:
      - "4040:4040"  # ngrok web UI
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
      NGROK_REGION: ${NGROK_REGION:-us}
    profiles:
      - ngrok
    depends_on:
      - wordpress

volumes:
  wordpress_data:
  redis_data:
  db_data:
